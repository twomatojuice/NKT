<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Information</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --primary-text-color: #212529;
            --secondary-text-color: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-bg-faded: #cfe2ff;
            --accent-text-dark: #003d80;
            --danger-color: #dc3545;
            --danger-dark-color: #c82333;
            --success-color: #28a745;
            --warning-color: #fd7e14;
            --paid-bg-color: #d4edda;
            --paid-text-color: #155724;
            --paid-marker-bg-color: #f1f3f5;
            --paid-marker-text-color: #868e96;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            max-width: 1400px;
            margin: 0 auto;
        }
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 auto;
            position: sticky;
            top: 20px;
        }
        .calendar-container {
            flex: 0 0 auto; /* Don't grow or shrink, size is based on content */
            background-color: var(--card-background);
            padding: 2rem; /* Adjusted to match tenant info card */
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline; /* Align text baselines */
            margin-bottom: 1rem;
            padding-bottom: 1rem; /* Match main-header */
            border-bottom: 1px solid var(--border-color);
        }
        .calendar-header h2 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-text-color);
            text-transform: none;
        }
        .calendar-header button {
            background: none;
            border: 1px solid transparent;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
            color: var(--secondary-text-color);
        }
        .calendar-header button:hover {
            background-color: #f8f9fa;
            border-color: var(--border-color);
            color: var(--primary-text-color);
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 72px);
            text-align: center;
            gap: 5px;
        }
        .calendar-weekdays div {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--secondary-text-color);
            padding-bottom: 0.5rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 72px); /* Explicitly define column widths */
            text-align: center;
            gap: 5px;
        }
        .calendar-day {
            height: 72px; /* Set height to create a square */
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.8rem;
            transition: background-color 0.2s;
            overflow: hidden;
            box-sizing: border-box; /* Ensures padding is included in the total size */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .calendar-day.has-events {
            background-color: var(--paid-bg-color);
            border-color: var(--paid-text-color);
            cursor: pointer;
        }
        .calendar-day.has-events:hover {
            background-color: #c3e6cb; /* A slightly darker shade */
        }
        .calendar-day.has-paid-events {
            background-color: var(--paid-marker-bg-color);
            border-color: var(--paid-marker-text-color);
            cursor: pointer;
        }
        .calendar-day.has-paid-events:hover {
            background-color: #e9ecef;
        }
        .calendar-day.not-current-month .day-number {
            color: #ced4da;
        }
        .day-number {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .calendar-day.has-events .day-number {
             color: var(--paid-text-color);
        }
         .calendar-day.has-paid-events .day-number {
            color: var(--paid-marker-text-color);
        }
        .billing-events {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        .billing-event {
            background-color: transparent;
            color: var(--paid-text-color);
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0;
            border-radius: 0;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .paid-event {
            background-color: transparent;
            color: var(--paid-marker-text-color);
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0;
            border-radius: 0;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .overview-container {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .overview-container h2 {
            margin: 0 0 1rem 0;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-text-color);
            text-transform: none;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .overview-section {
            margin-bottom: 1.5rem;
        }

        .overview-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-text-color);
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--secondary-text-color);
            cursor: pointer;
        }

        .overview-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f5;
        }

        .overview-item span:last-child {
            font-weight: 500;
            color: var(--primary-text-color);
        }

        .overview-totals {
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .overview-item.total {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-text-color);
            border-bottom: none;
        }

        .overview-item.total span:last-child {
            font-size: 1.1rem;
        }

        .main-container {
            flex: 2;
            width: 100%;
            max-width: 900px;
            margin: 0; /* Reset margin */
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline; /* Align text baselines */
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin: 0;
            padding: 0;
            border: none;
        }
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        #set-rate-btn,
        #modal-renew-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            padding: 0.5rem 1rem;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        #set-rate-btn:hover,
        #modal-renew-btn:hover {
            background-color: #f8f9fa;
            color: var(--primary-text-color);
            border-color: #adb5bd;
        }
        .floor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--secondary-text-color);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .add-tenant-btn {
            background: none;
            border: none;
            font-family: inherit;
            color: var(--secondary-text-color);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.25rem;
            transition: color 0.2s ease-in-out;
        }
        .add-tenant-btn:hover {
            color: var(--accent-color);
        }
        .floor-container {
            margin-bottom: 2.5rem;
        }
        .tenant-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .tenant-item {
            border-bottom: 1px solid var(--border-color);
        }
        .tenant-item:last-child {
            border-bottom: none;
        }
        .tenant-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background-color: 0.2s ease-in-out;
        }
        .tenant-summary:hover {
            background-color: #f6f7f9;
        }
        .tenant-item.expanded > .tenant-summary {
            background-color: #f6f7f9;
        }
        .tenant-details {
            display: flex;
            flex-direction: column;
        }
        .tenant-name {
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            min-height: 1.2rem;
        }
        .tenant-unit {
            font-size: 0.875rem;
            color: var(--secondary-text-color);
        }
        .tenant-status-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 90px;
            text-align: center;
            box-sizing: border-box;
        }
        .status-paid {
            background-color: var(--paid-bg-color);
            color: var(--paid-text-color);
        }
        .status-billing {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        .tenant-expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background-color: #f6f7f9;
            padding: 0 1.25rem;
        }
        .tenant-item.expanded > .tenant-expanded-details {
            max-height: 600px;
            padding: 1.5rem 1.25rem;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            font-size: 0.875rem;
        }
        .details-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .details-section strong {
            color: var(--primary-text-color);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .details-section span {
            color: var(--secondary-text-color);
        }
        .details-section .expiring-date {
            color: var(--danger-color);
        }
        .details-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .action-buttons-left,
        .action-buttons-right {
            display: flex;
            gap: 0.5rem;
        }
        .action-buttons-left button,
        .action-buttons-right button {
            background-color: #dddee0;
            color: var(--secondary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 90px;
            text-align: center;
        }
        .action-buttons-left button:hover,
        .action-buttons-right button:hover {
            background-color: #ced4da;
            border-color: #adb5bd;
        }
        .action-buttons-left .bill-btn {
            background-color: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }
        .action-buttons-left .bill-btn:hover {
            background-color: #e67311;
            border-color: #d1680f;
        }
        .action-buttons-right .paid-btn {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .action-buttons-right .paid-btn:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        #add-section-btn {
            width: 100%;
            background-color: transparent;
            border: 1px dashed var(--border-color);
            color: var(--secondary-text-color);
            padding: 0.75rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-top: 1rem;
        }
        #add-section-btn:hover {
            background-color: #f8f9fa;
            color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-content {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 500px;
            transition: max-width 0.3s ease;
        }
        .modal-content.history-modal {
            max-width: 800px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        #modal-inputs {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 1rem;
            margin-right: -1rem;
        }
        .modal-confirmation-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--secondary-text-color);
            margin-bottom: 1rem;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .modal-spacer {
            height: 4rem;
        }
        .input-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .input-group-header label {
            margin-bottom: 0;
        }
        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--secondary-text-color);
        }
        .radio-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 400;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none;
        }
        .modal-input.is-invalid {
            border-color: var(--danger-color);
        }
        .modal-input.is-invalid:focus {
            border-color: var(--danger-color);
        }
        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }
        .modal-input.is-invalid + .invalid-feedback {
            display: block;
        }
        .modal-input.vehicle-input {
            padding-right: 2.5rem;
        }
        .vehicle-input-group {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: -1px;
        }
        #vehicle-input-container .modal-input {
            border-radius: 0;
        }
        #vehicle-input-container .vehicle-input-group:first-child .modal-input {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #vehicle-input-container .vehicle-input-group:last-child .modal-input {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        .vehicle-input-group input {
            flex-grow: 1;
        }
        #add-vehicle-btn {
            font-size: 0.875rem;
            color: var(--accent-color);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.25rem;
            font-weight: 500;
        }
        .remove-vehicle-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--primary-text-color);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0 0.75rem;
            line-height: 1;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .modal-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color: 0.2s ease;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .modal-btn-primary:hover {
            background-color: #0056b3;
        }
        .modal-btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal-btn-secondary {
            background-color: #e9ecef;
            color: var(--secondary-text-color);
        }
        .modal-btn-secondary:hover {
            background-color: #ced4da;
        }
        .context-menu {
            position: absolute;
            z-index: 1001;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--primary-text-color);
            cursor: pointer;
            transition: background-color: 0.2s ease;
        }
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                align-items: center;
            }
             .left-column {
                width: 100%;
                max-width: 900px;
                box-sizing: border-box;
                position: static;
            }
             .calendar-container {
                width: 100%;
            }
             .main-container {
                max-width: 100%;
            }
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .main-container, .calendar-container, .overview-container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .main-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .tenant-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .details-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            .action-buttons-left,
            .action-buttons-right {
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="left-column">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <h2 id="calendar-month-year"></h2>
                    <button id="next-month-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            <div class="overview-container">
                <h2>Overview</h2>
                <div class="overview-section">
                    <h3>Income</h3>
                    <div class="overview-item"><span>Unit total:</span><span id="overview-income-unit">0.00 USD</span></div>
                    <div class="overview-item"><span>Parking total:</span><span id="overview-income-parking">0.00 USD</span></div>
                    <div class="overview-item"><span>Consumption total:</span><span id="overview-income-consumption">0.00 USD</span></div>
                    <div class="overview-item"><span>Other:</span><span id="overview-income-other">0.00 USD</span></div>
                </div>
                 <div class="overview-section">
                    <h3 id="expense-header">Expense</h3>
                    <div class="overview-item"><span>Employee salary:</span><span id="overview-expense-salary">0.00 USD</span></div>
                    <div class="overview-item"><span>Maintenance:</span><span id="overview-expense-maintenance">0.00 USD</span></div>
                    <div class="overview-item"><span>Tax:</span><span id="overview-expense-tax">0.00 USD</span></div>
                    <div class="overview-item"><span>Other:</span><span id="overview-expense-other">0.00 USD</span></div>
                </div>
                <div class="overview-totals">
                    <div class="overview-item total"><span>Total Profit:</span><span id="overview-total-profit">0.00 USD</span></div>
                    <div class="overview-item total"><span>Net Profit:</span><span id="overview-net-profit">0.00 USD</span></div>
                </div>
            </div>
        </div>
        <div class="main-container">
            <div class="main-header">
                <h1>Tenant Information</h1>
                <div class="header-actions">
                    <button id="set-rate-btn">Set rate</button>
                </div>
            </div>
            <div id="sections-container"></div>
            <button id="add-section-btn">+ add section</button>
        </div>
    </div>
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-renew-btn" style="display: none;">Renew</button>
            </div>
            <div id="modal-inputs"></div>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="modal-btn modal-btn-primary">Save</button>
            </div>
        </div>
    </div>
    <div id="context-menu" class="context-menu" style="display: none;"></div>
    <script>
        (function() {
            'use strict';
            // #################################################################
            // ##                         APPLICATION STATE                   ##
            // #################################################################
            const state = {
                rates: { electricity: 0.25, water: 1.0, parking: 50.0 },
                sections: [],
                expenses: {},
                defaultTenantState: {
                    name: '', phone: '', leaseStart: "", leaseEnd: "", tenure: "", currentBillingDate: "",
                    nationality: 'Local', idExpiry: '', passportExpiry: "", visaExpiry: "", fpcs: "No", pax: "",
                    vehicles: [], elecPrev: "", elecCurrent: "", waterPrev: "", waterCurrent: "", rent: "",
                    other: "", paymentHistory: [],
                },
                nextSectionId: 1,
                nextTenantId: 1,
                currentModalCallback: null,
                currentModalCancelCallback: null,
                currentlyExpandedTenantId: null,
                currentlyEditingTenantId: null,
                isModalOpen: false,
                calendarDate: new Date(),
                // Temporary store for calendar event data to be used by modals
                tempCalendarData: { billing: {}, paid: {} },
            };

            // #################################################################
            // ##                         API & DATA SYNC                     ##
            // #################################################################
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoNBzSqC6pR4QuRTDlxsBOYUj5180vCz1KbeRbWb3P21OLW4ne28XV7HZvhfCbeqpf/exec";

            async function loadDataFromSheet() {
                if (state.isModalOpen) {
                    console.log("Modal is open, skipping background sync.");
                    return;
                }
                console.log("Fetching data from Google Sheet...");
                try {
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) throw new Error("Failed to load data from sheet.");
                    const freshData = await response.json();
                                        const currentDataSignature = JSON.stringify({ rates: state.rates, sections: state.sections, expenses: state.expenses });
                    const freshDataSignature = JSON.stringify(freshData);

                    if (currentDataSignature !== freshDataSignature) {
                        console.log("New data found from Google Sheet. Refreshing UI.");
                        state.rates = freshData.rates && Object.keys(freshData.rates).length > 0 ? freshData.rates : state.rates;
                        state.sections = freshData.sections && freshData.sections.length > 0 ? freshData.sections : state.sections;
                        state.expenses = freshData.expenses || {};

                        if (state.sections.length > 0) {
                            const allTenantIds = state.sections.flatMap(s => s.tenants.map(t => t.id));
                            state.nextTenantId = Math.max(0, ...allTenantIds) + 1;
                            const allSectionIds = state.sections.map(s => s.id);
                            state.nextSectionId = Math.max(0, ...allSectionIds) + 1;
                        }
                                                render();
                    } else {
                        console.log("Local cache is up-to-date.");
                    }
                } catch (error) {
                    console.error("Could not sync with Google Sheet, running from local cache:", error);
                }
            }
            async function saveDataToSheet() {
                console.log("Syncing data to Google Sheet in the background...");
                try {
                    // Removed 'no-cors' to allow the request body to be sent and a response to be read.
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            // Using text/plain is more robust for Apps Script web apps
                            'Content-Type': 'text/plain;charset=utf-8', 
                        },
                        body: JSON.stringify(state)
                    });
            
                    // Now we can check the response from the server for success or failure
                    const result = await response.json();
                    if (result.status === "success") {
                        console.log("Sync successful:", result.message);
                    } else {
                        console.error("Sync failed:", result.message);
                    }
                } catch (error) {
                    console.error("Error syncing data to Google Sheet:", error);
                }
            }
            // #################################################################
            // ##                           DOM SELECTORS                     ##
            // #################################################################
            const DOM = {
                sectionsContainer: document.getElementById('sections-container'),
                addSectionBtn: document.getElementById('add-section-btn'),
                setRateBtn: document.getElementById('set-rate-btn'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalTitle: document.getElementById('modal-title'),
                modalRenewBtn: document.getElementById('modal-renew-btn'),
                modalInputsContainer: document.getElementById('modal-inputs'),
                modalSaveBtn: document.getElementById('modal-save-btn'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
                contextMenu: document.getElementById('context-menu'),
                calendarGrid: document.getElementById('calendar-grid'),
                calendarMonthYear: document.getElementById('calendar-month-year'),
                prevMonthBtn: document.getElementById('prev-month-btn'),
                nextMonthBtn: document.getElementById('next-month-btn'),
                overviewIncomeUnit: document.getElementById('overview-income-unit'),
                overviewIncomeConsumption: document.getElementById('overview-income-consumption'),
                overviewIncomeParking: document.getElementById('overview-income-parking'),
                overviewIncomeOther: document.getElementById('overview-income-other'),
                overviewExpenseSalary: document.getElementById('overview-expense-salary'),
                overviewExpenseMaintenance: document.getElementById('overview-expense-maintenance'),
                overviewExpenseTax: document.getElementById('overview-expense-tax'),
                overviewExpenseOther: document.getElementById('overview-expense-other'),
                overviewTotalProfit: document.getElementById('overview-total-profit'),
                overviewNetProfit: document.getElementById('overview-net-profit'),
                expenseHeader: document.getElementById('expense-header'),
            };

            // #################################################################
            // ##                             UTILITIES                       ##
            // #################################################################

            /** Formats an ISO date string to DD-MM-YYYY format. */
            function formatDate(isoString) {
                if (!isoString) return "";
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return "";
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                return `${day}-${month}-${year}`;
            }

            /** Formats an ISO date string to DD/MM/YYYY format for modal titles. */
            function formatDateForModalTitle(isoString) {
                if (!isoString) return "";
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return "";
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                return `${day}/${month}/${year}`;
            }

            /** Checks if a date is within the next 30 days. */
            function isDateExpiring(isoDateString) {
                if (!isoDateString) return false;
                const date = new Date(isoDateString);
                if (isNaN(date.getTime())) return false;
                                const now = new Date();
                const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setUTCDate(today.getUTCDate() + 30);
                const inputDateUTC = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                                return inputDateUTC <= thirtyDaysFromNow && inputDateUTC >= today;
            }

            function addMonthsAndClamp(isoDate, months) {
                const date = new Date(isoDate + 'T00:00:00Z');
                if (isNaN(date.getTime())) return "";

                const originalDay = date.getUTCDate();
                
                // Set the date to the first of the month before adding months to avoid rollover issues
                date.setUTCDate(1);
                date.setUTCMonth(date.getUTCMonth() + months);

                // Get the last day of the new month
                const daysInMonth = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth() + 1, 0)).getUTCDate();
                
                // Set the day to the original day, or the last day of the month if it's shorter
                date.setUTCDate(Math.min(originalDay, daysInMonth));
                
                return date.toISOString().split('T')[0];
            }


            /** Calculates the next billing date by adding one month, handling end-of-month logic. */
            function calculateNextBillingDate(currentBillingISO, leaseStartISO) {
                if (leaseStartISO) {
                    const leaseStartDate = new Date(leaseStartISO + 'T00:00:00Z');
                    const currentBillingDate = new Date(currentBillingISO + 'T00:00:00Z');
                    
                    let monthsElapsed = (currentBillingDate.getUTCFullYear() - leaseStartDate.getUTCFullYear()) * 12 + (currentBillingDate.getUTCMonth() - leaseStartDate.getUTCMonth());
                    
                    // If the billing day is less than the lease start day, it implies we've just crossed a shorter month boundary.
                    if (currentBillingDate.getUTCDate() < leaseStartDate.getUTCDate()) {
                        // This ensures we calculate the next month from the lease start, not the adjusted date.
                    } else {
                       monthsElapsed++;
                    }

                    return addMonthsAndClamp(leaseStartISO, monthsElapsed);
                }
                
                // Fallback for older data or cases without a lease start
                return addMonthsAndClamp(currentBillingISO, 1);
            }

            /** Calculates the first billing date from the lease start date. */
            function calculateFirstBillingDate(leaseStart) {
                return addMonthsAndClamp(leaseStart, 1);
            }

            /** Finds a tenant by their ID. */
            function findTenant(tenantId) {
                for (const section of state.sections) {
                    const tenant = section.tenants.find(t => t.id === tenantId);
                    if (tenant) return { tenant, section };
                }
                return { tenant: null, section: null };
            }

            /** Calculates the lease end date based on start and tenure. */
            function calculateLeaseEndDate(leaseStart, tenure) {
                const tenureMonths = parseInt(tenure, 10);
                 if (isNaN(tenureMonths) || !leaseStart) return null;
                return addMonthsAndClamp(leaseStart, tenureMonths);
            }

            // #################################################################
            // ##                           UI RENDERING                      ##
            // #################################################################
             function renderOverview() {
                const date = state.calendarDate;
                const year = date.getFullYear();
                const month = date.getMonth();

                let incomeUnit = 0;
                let incomeConsumption = 0;
                let incomeParking = 0;
                let incomeOther = 0;

                const allTenants = state.sections.flatMap(s => s.tenants);

                allTenants.forEach(tenant => {
                    if (!tenant.paymentHistory) return;

                    tenant.paymentHistory.forEach(entry => {
                        const paidDate = new Date(entry.paidOn);
                        if (paidDate.getUTCFullYear() === year && paidDate.getUTCMonth() === month) {
                            incomeUnit += entry.rent || 0;
                            incomeParking += entry.parking || 0;
                            incomeOther += entry.other || 0;

                            // Calculate consumption costs from usage strings
                            const elecUsage = parseFloat(entry.elecUsage) || 0;
                            const waterUsage = parseFloat(entry.waterUsage) || 0;
                            incomeConsumption += (elecUsage * state.rates.electricity) + (waterUsage * state.rates.water);
                        }
                    });
                });

                const expenseKey = `${year}-${month}`;
                const currentExpenses = state.expenses[expenseKey] || { salary: 0, maintenance: 0, tax: 0, other: 0 };
                
                const totalIncome = incomeUnit + incomeConsumption + incomeParking + incomeOther;
                const totalExpense = currentExpenses.salary + currentExpenses.maintenance + currentExpenses.tax + currentExpenses.other;
                const totalProfit = totalIncome - totalExpense;
                const netProfit = totalProfit > 0 ? totalProfit * 0.9 : 0; // Assuming 10% tax on profit for net

                // Update DOM
                DOM.overviewIncomeUnit.textContent = `${incomeUnit.toFixed(2)} USD`;
                DOM.overviewIncomeConsumption.textContent = `${incomeConsumption.toFixed(2)} USD`;
                DOM.overviewIncomeParking.textContent = `${incomeParking.toFixed(2)} USD`;
                DOM.overviewIncomeOther.textContent = `${incomeOther.toFixed(2)} USD`;

                DOM.overviewExpenseSalary.textContent = `${currentExpenses.salary.toFixed(2)} USD`;
                DOM.overviewExpenseMaintenance.textContent = `${currentExpenses.maintenance.toFixed(2)} USD`;
                DOM.overviewExpenseTax.textContent = `${currentExpenses.tax.toFixed(2)} USD`;
                DOM.overviewExpenseOther.textContent = `${currentExpenses.other.toFixed(2)} USD`;

                DOM.overviewTotalProfit.textContent = `${totalProfit.toFixed(2)} USD`;
                DOM.overviewNetProfit.textContent = `${netProfit.toFixed(2)} USD`;
            }
            /** Renders the calendar view for the month in the current state. */
            function renderCalendar() {
                const date = state.calendarDate;
                const year = date.getFullYear();
                const month = date.getMonth();

                DOM.calendarMonthYear.textContent = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                DOM.calendarGrid.innerHTML = '';
                
                // Reset temporary data
                state.tempCalendarData = { billing: {}, paid: {} };

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const allTenants = state.sections.flatMap(s => s.tenants);
                
                // Process and store all relevant calendar events for the current view
                allTenants.forEach(tenant => {
                    // 1. Upcoming billing events
                    if (tenant.currentBillingDate) {
                        const billingDate = new Date(tenant.currentBillingDate);
                        if (billingDate.getUTCFullYear() === year && billingDate.getUTCMonth() === month) {
                            const day = billingDate.getUTCDate();
                            if (!state.tempCalendarData.billing[day]) state.tempCalendarData.billing[day] = [];
                            state.tempCalendarData.billing[day].push({ tenant });
                        }
                    }
                    // 2. Historical paid events
                    if (tenant.paymentHistory) {
                        tenant.paymentHistory.forEach(entry => {
                            const paidDate = new Date(entry.paidOn);
                            if (paidDate.getUTCFullYear() === year && paidDate.getUTCMonth() === month) {
                                const day = paidDate.getUTCDate();
                                if (!state.tempCalendarData.paid[day]) state.tempCalendarData.paid[day] = [];
                                state.tempCalendarData.paid[day].push({ tenant, entry });
                            }
                        });
                    }
                });

                let cellCount = 0;
                const totalGridCells = 42;

                for (let i = 0; i < firstDay; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day not-current-month';
                    DOM.calendarGrid.appendChild(dayCell);
                    cellCount++;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';

                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = i;
                    dayCell.appendChild(dayNumber);
                    
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'billing-events';

                    const hasBillingEvents = state.tempCalendarData.billing[i]?.length > 0;
                    const hasPaidEvents = state.tempCalendarData.paid[i]?.length > 0;

                    if (hasBillingEvents) {
                        dayCell.classList.add('has-events');
                        dayCell.dataset.day = i;
                        dayCell.dataset.type = 'billing';

                        let dailyTotal = 0;
                        state.tempCalendarData.billing[i].forEach(item => {
                            dailyTotal += getBillingInfo(item.tenant).totalBilling;
                        });

                        if (dailyTotal > 0) {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'billing-event';
                            eventDiv.textContent = `+${Math.round(dailyTotal)}`;
                            eventsContainer.appendChild(eventDiv);
                        }
                    } else if (hasPaidEvents) {
                        dayCell.classList.add('has-paid-events');
                        dayCell.dataset.day = i;
                        dayCell.dataset.type = 'paid';

                        let dailyTotalPaid = 0;
                        state.tempCalendarData.paid[i].forEach(item => {
                            dailyTotalPaid += item.entry.totalPaid;
                        });

                        if (dailyTotalPaid > 0) {
                             const paidDiv = document.createElement('div');
                            paidDiv.className = 'paid-event';
                            paidDiv.textContent = `+${Math.round(dailyTotalPaid)}`;
                            eventsContainer.appendChild(paidDiv);
                        }
                    }

                    if (eventsContainer.hasChildNodes()) {
                        dayCell.appendChild(eventsContainer);
                    }
                    
                    DOM.calendarGrid.appendChild(dayCell);
                    cellCount++;
                }

                while (cellCount < totalGridCells) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day not-current-month';
                    DOM.calendarGrid.appendChild(dayCell);
                    cellCount++;
                }
            }
            /** Gets tenant billing calculations. */
            function getBillingInfo(tenant) {
                let elecUsage = 0;
                const elecCurrentNum = parseFloat(tenant.elecCurrent);
                const elecPrevNum = parseFloat(tenant.elecPrev || 0);
                if (!isNaN(elecCurrentNum) && elecCurrentNum >= elecPrevNum) {
                    elecUsage = elecCurrentNum - elecPrevNum;
                }
            
                let waterUsage = 0;
                const waterCurrentNum = parseFloat(tenant.waterCurrent);
                const waterPrevNum = parseFloat(tenant.waterPrev || 0);
                if (!isNaN(waterCurrentNum) && waterCurrentNum >= waterPrevNum) {
                    waterUsage = waterCurrentNum - waterPrevNum;
                }
            
                const elecBilling = elecUsage * state.rates.electricity;
                const waterBilling = waterUsage * state.rates.water;
                const parkingBilling = (tenant.vehicles?.length || 0) * state.rates.parking;
                const totalBilling = elecBilling + waterBilling + parseFloat(tenant.rent || 0) + parseFloat(tenant.other || 0) + parkingBilling;
                return { elecBilling, waterBilling, parkingBilling, totalBilling };
            }
            /** Determines the status badge for a tenant. */
            function getStatusInfo(tenant) {
                if (!tenant.name) return { badgeHTML: '', showActionButtons: false, showPaidButton: false };

                const now = new Date();
                const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
                const currentBillingDateObj = tenant.currentBillingDate ? new Date(tenant.currentBillingDate) : null;
                                let badgeText = 'Paid';
                let badgeClass = 'status-paid';
                let showActionButtons = false;

                if (currentBillingDateObj && !isNaN(currentBillingDateObj.getTime())) {
                    const threeDaysBeforeBilling = new Date(currentBillingDateObj);
                    threeDaysBeforeBilling.setUTCDate(threeDaysBeforeBilling.getUTCDate() - 3);

                    if (today > currentBillingDateObj) {
                        badgeText = 'Overdue';
                        badgeClass = 'status-overdue';
                        showActionButtons = true;
                    } else if (today >= threeDaysBeforeBilling) {
                        badgeText = 'Billing';
                        badgeClass = 'status-billing';
                        showActionButtons = true;
                    }
                }
                                const badgeHTML = `<span class="tenant-status-badge ${badgeClass}">${badgeText}</span>`;
                const showPaidButton = showActionButtons && tenant.elecCurrent && tenant.waterCurrent;

                return { badgeHTML, showActionButtons, showPaidButton };
            }
            /** Creates the HTML for the expanded details of a tenant. */
            function createTenantExpandedDetailsHTML(tenant, billingInfo, statusInfo) {
                const { elecBilling, waterBilling, parkingBilling, totalBilling } = billingInfo;
                const { showActionButtons, showPaidButton } = statusInfo;
                                // Document Details
                let documentDetails = '';
                if (tenant.nationality === 'Local') {
                    const idExpiryClass = isDateExpiring(tenant.idExpiry) ? 'class="expiring-date"' : '';
                    documentDetails = `<span ${idExpiryClass}>ID Expiry: ${formatDate(tenant.idExpiry)}</span>`;
                } else {
                    const passportExpiryClass = isDateExpiring(tenant.passportExpiry) ? 'class="expiring-date"' : '';
                    const visaExpiryClass = isDateExpiring(tenant.visaExpiry) ? 'class="expiring-date"' : '';
                    documentDetails = `
                        <span ${passportExpiryClass}>Passport Expiry: ${formatDate(tenant.passportExpiry)}</span>
                        <span ${visaExpiryClass}>Visa Expiry: ${formatDate(tenant.visaExpiry)}</span>`;
                }
                                // Other Details
                const leaseEndClass = isDateExpiring(tenant.leaseEnd) ? 'class="expiring-date"' : '';
                const contactDetails = tenant.nationality === 'Local'
                     ? `<span>Phone: ${tenant.phone}</span><span>Pax: ${tenant.pax || ''}</span>`
                     : `<span>Phone: ${tenant.phone}</span><span>FPCS Registry: ${tenant.fpcs}</span><span>Pax: ${tenant.pax || ''}</span>`;
                const vehicleListHTML = tenant.vehicles?.length > 0 ? `<span>${tenant.vehicles.join('<br>')}</span>` : '';
                                // Action Buttons
                const historyButtonHTML = tenant.paymentHistory?.length > 0 ? '<button class="history-btn">History</button>' : '';
                const billButtonHTML = showActionButtons ? '<button class="bill-btn">Bill</button>' : '';
                const paidButtonHTML = showPaidButton ? '<button class="paid-btn">Paid</button>' : '';

                return `
                    <div class="details-grid">
                        <div class="details-section"><strong>Lease</strong><span>Start: ${formatDate(tenant.leaseStart)}</span><span ${leaseEndClass}>End: ${formatDate(tenant.leaseEnd)}</span><span>Tenure: ${tenant.tenure ? tenant.tenure + ' month' : ''}</span></div>
                        <div class="details-section"><strong>Documents</strong>${documentDetails}</div>
                        <div class="details-section"><strong>Contact</strong>${contactDetails}</div>
                        <div class="details-section"><strong>Vehicles</strong>${vehicleListHTML}<span>Billing: ${vehicleListHTML ? parkingBilling.toFixed(2) + ' USD' : ''}</span></div>
                        <div class="details-section"><strong>Electricity Usage</strong><span>Previous: ${tenant.elecPrev ? tenant.elecPrev + ' Kwh' : ''}</span><span>New: ${tenant.elecCurrent ? tenant.elecCurrent + ' Kwh' : ''}</span><span>Billing: ${tenant.elecCurrent ? elecBilling.toFixed(2) + ' USD' : ''}</span></div>
                        <div class="details-section"><strong>Water Usage</strong><span>Previous: ${tenant.waterPrev ? tenant.waterPrev + ' m' : ''}</span><span>New: ${tenant.waterCurrent ? tenant.waterCurrent + ' m' : ''}</span><span>Billing: ${tenant.waterCurrent ? waterBilling.toFixed(2) + ' USD' : ''}</span></div>
                        <div class="details-section"><strong>Payment</strong><span>Billing Date: ${formatDate(tenant.currentBillingDate)}</span><span>Rent: ${tenant.rent ? tenant.rent + ' USD' : ''}</span><span>Other: ${tenant.other ? tenant.other + ' USD' : ''}</span><strong>Total billing: ${totalBilling > 0 ? totalBilling.toFixed(2) + ' USD' : ''}</strong></div>
                    </div>
                    <div class="details-actions">
                        <div class="action-buttons-left"><button class="dlt-btn">Delete</button><button class="edt-btn">Edit</button>${historyButtonHTML}${billButtonHTML}</div>
                        <div class="action-buttons-right">${paidButtonHTML}</div>
                    </div>`;
            }

            /** Creates a tenant list item element. */
            function createTenantListItem(tenant) {
                const billingInfo = getBillingInfo(tenant);
                const statusInfo = getStatusInfo(tenant);
                const expandedDetailsHTML = createTenantExpandedDetailsHTML(tenant, billingInfo, statusInfo);
                                const listItem = document.createElement('li');
                listItem.className = 'tenant-item';
                listItem.dataset.tenantId = tenant.id;
                if (tenant.id === state.currentlyExpandedTenantId) {
                    listItem.classList.add('expanded');
                }
                                listItem.innerHTML = `
                    <div class="tenant-summary">
                        <div class="tenant-details">
                            <span class="tenant-name">${tenant.name || 'No Name Assigned'}</span>
                            <span class="tenant-unit">Unit: ${tenant.unit}</span>
                        </div>
                        ${statusInfo.badgeHTML}
                    </div>
                    <div class="tenant-expanded-details">${expandedDetailsHTML}</div>`;
                return listItem;
            }

            /** Creates a section element with its tenants. */
            function createSectionElement(section) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'floor-container';
                sectionDiv.dataset.sectionId = section.id;

                const header = document.createElement('div');
                header.className = 'floor-header';
                header.innerHTML = `<h2>${section.name}</h2><button class="add-tenant-btn" data-section-id="${section.id}">+ add unit</button>`;

                const tenantList = document.createElement('ul');
                tenantList.className = 'tenant-list';
                section.tenants.forEach(tenant => tenantList.appendChild(createTenantListItem(tenant)));

                sectionDiv.append(header, tenantList);
                return sectionDiv;
            }
            /** Renders the entire application based on the current state. */
            function render() {
                DOM.sectionsContainer.innerHTML = '';
                state.sections.forEach(section => {
                    DOM.sectionsContainer.appendChild(createSectionElement(section));
                });
                renderCalendar();
                renderOverview();
            }

            // #################################################################
            // ##                      MODAL & CONTEXT MENU                   ##
            // #################################################################
            let currentValidationHandler = null;
            function createModalField(field, initialValue = '') {
                const group = document.createElement('div');
                group.className = 'input-group';
                                if (field.type === 'vehicles') {
                    group.innerHTML = `<div class="input-group-header"><label for="${field.id}">${field.label}</label><button type="button" id="add-vehicle-btn">+ add vehicle</button></div>`;
                    const vehicleContainer = document.createElement('div');
                    vehicleContainer.id = 'vehicle-input-container';
                    const vehicles = initialValue || [];
                    if (vehicles.length === 0) {
                        vehicleContainer.appendChild(createVehicleInput('', true));
                    } else {
                        vehicles.forEach((v, i) => vehicleContainer.appendChild(createVehicleInput(v, i === 0)));
                    }
                    group.appendChild(vehicleContainer);
                } else {
                    const label = document.createElement('label');
                    label.setAttribute('for', field.id);
                    label.textContent = field.label;
                    group.appendChild(label);

                    const input = document.createElement('input');
                    input.type = field.type || 'text';
                    input.className = 'modal-input';
                    input.value = initialValue;
                    input.placeholder = field.placeholder || '';
                    input.id = field.id;
                    if (field.type === 'number') { input.min = "0"; }
                    group.appendChild(input);

                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.id = `${field.id}-error`;
                    group.appendChild(errorDiv);
                }
                return group;
            }

            function createRadioGroup(name, options, selectedValue) {
                const group = document.createElement('div');
                group.className = 'radio-group';
                options.forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = name;
                    input.value = option;
                    if (option === selectedValue) {
                        input.checked = true;
                    }
                    label.append(input, ` ${option}`);
                    group.appendChild(label);
                });
                return group;
            }
            function createVehicleInput(value = '', isFirst = false) {
                const container = document.createElement('div');
                container.className = 'vehicle-input-group';
                const removeButtonHTML = isFirst ? '' : `<button type="button" class="remove-vehicle-btn">&times;</button>`;
                container.innerHTML = `
                    <input type="text" class="modal-input vehicle-input" value="${value}" placeholder="">
                    ${removeButtonHTML}
                `;
                return container;
            }

            function showModal(config) {
                state.isModalOpen = true;
                if (currentValidationHandler) {
                    DOM.modalInputsContainer.removeEventListener('input', currentValidationHandler);
                    currentValidationHandler = null;
                }

                const { title, fields = [], initialValues = {}, onSave, onCancel, isConfirmation = false, confirmationText = "", isEdit = false, isDelete = false, saveButtonText = "Save", requiredFields = [], validationRules = [], hideActionsBorder = false } = config;

                DOM.modalTitle.textContent = title;
                DOM.modalInputsContainer.innerHTML = '';
                DOM.modalRenewBtn.style.display = isEdit ? 'block' : 'none';
                DOM.modalCancelBtn.style.display = 'inline-block';
                
                const modalContent = DOM.modalOverlay.querySelector('.modal-content');
                if (config.isHistory) {
                    modalContent.classList.add('history-modal');
                } else {
                    modalContent.classList.remove('history-modal');
                }


                if (isConfirmation) {
                    DOM.modalSaveBtn.disabled = false;
                    DOM.modalInputsContainer.innerHTML = `<div class="modal-confirmation-text">${confirmationText}</div>`;
                    DOM.modalSaveBtn.textContent = saveButtonText || "Confirm";
                    if (isDelete) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'modal-input';
                        input.placeholder = "Type 'confirm' to proceed";
                        DOM.modalInputsContainer.appendChild(input);
                        DOM.modalSaveBtn.textContent = "Proceed";
                        DOM.modalSaveBtn.disabled = true;
                        input.addEventListener('input', () => {
                            DOM.modalSaveBtn.disabled = input.value.toLowerCase() !== 'confirm';
                        });
                    }
                } else {
                    fields.forEach(field => {
                        let element;
                        switch (field.type) {
                            case 'spacer':
                                element = document.createElement('div');
                                element.className = 'modal-spacer';
                                break;
                            case 'nationality':
                                element = document.createElement('div');
                                element.className = 'input-group';
                                element.innerHTML = `<label>Nationality</label>`;
                                element.appendChild(createRadioGroup('nationality', ['Local', 'Foreigner'], initialValues.nationality));
                                break;
                            case 'documentFields':
                            case 'fpcsFields':
                                element = document.createElement('div');
                                element.id = field.type === 'documentFields' ? 'document-fields-container' : 'fpcs-fields-container';
                                break;
                            default:
                                element = createModalField(field, initialValues[field.id]);
                                break;
                        }
                        DOM.modalInputsContainer.appendChild(element);
                    });

                    if (isEdit) {
                        const nationalityRadios = document.querySelectorAll('input[name="nationality"]');
                        nationalityRadios.forEach(radio => radio.addEventListener('change', () => updateDynamicEditFields(initialValues)));
                        updateDynamicEditFields(initialValues);
                    }
                                        const nameInput = DOM.modalInputsContainer.querySelector('#name');
                    const paxInput = DOM.modalInputsContainer.querySelector('#pax');
                    if (nameInput && paxInput) {
                        nameInput.addEventListener('input', () => {
                            if (nameInput.value.trim() && (!paxInput.value.trim() || paxInput.value.trim() === '0')) {
                                paxInput.value = '1';
                                paxInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger validation
                            }
                        });
                    }
                    DOM.modalSaveBtn.textContent = saveButtonText;
                }
                const validate = () => {
                    let isAllValid = true;
                    DOM.modalInputsContainer.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    DOM.modalInputsContainer.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

                    requiredFields.forEach(fieldId => {
                        const input = DOM.modalInputsContainer.querySelector(`#${fieldId}`);
                        if (input && input.value.trim() === '') {
                            isAllValid = false;
                            input.classList.add('is-invalid');
                            document.getElementById(`${fieldId}-error`).textContent = 'This field is required.';
                        }
                    });

                    validationRules.forEach(rule => {
                        const input = DOM.modalInputsContainer.querySelector(`#${rule.fieldId}`);
                        if (input && !rule.validator(input.value)) {
                            isAllValid = false;
                            input.classList.add('is-invalid');
                            document.getElementById(`${rule.fieldId}-error`).textContent = rule.message;
                        }
                    });
                                        DOM.modalSaveBtn.disabled = !isAllValid;
                };

                if (requiredFields.length > 0 || validationRules.length > 0) {
                    currentValidationHandler = validate;
                    DOM.modalInputsContainer.addEventListener('input', currentValidationHandler);
                    validate();
                } else if (!isDelete) {
                    DOM.modalSaveBtn.disabled = false;
                }
                state.currentModalCallback = onSave;
                state.currentModalCancelCallback = onCancel;
                DOM.modalOverlay.classList.add('show');
                DOM.modalInputsContainer.querySelector('input, button')?.focus();
            }
            function updateDynamicEditFields(initialValues) {
                const docContainer = document.getElementById('document-fields-container');
                const fpcsContainer = document.getElementById('fpcs-fields-container');
                if (!docContainer || !fpcsContainer) return;

                const selectedNationality = document.querySelector('input[name="nationality"]:checked').value;
                docContainer.innerHTML = '';
                fpcsContainer.innerHTML = '';

                if (selectedNationality === 'Local') {
                    docContainer.appendChild(createModalField({ id: 'idExpiry', label: 'ID Expiry', type: 'date' }, initialValues.idExpiry || ''));
                } else {
                    docContainer.appendChild(createModalField({ id: 'passportExpiry', label: 'Passport Expiry', type: 'date' }, initialValues.passportExpiry || ''));
                    docContainer.appendChild(createModalField({ id: 'visaExpiry', label: 'Visa Expiry', type: 'date' }, initialValues.visaExpiry || ''));
                    const fpcsGroup = document.createElement('div');
                    fpcsGroup.className = 'input-group';
                    fpcsGroup.innerHTML = `<label>FPCS Registry</label>`;
                    fpcsGroup.appendChild(createRadioGroup('fpcs', ['Yes', 'No'], initialValues.fpcs));
                    fpcsContainer.appendChild(fpcsGroup);
                }
            }

            function hideModal() {
                DOM.modalOverlay.classList.remove('show');
                state.currentModalCallback = null;
                state.currentModalCancelCallback = null;
                state.currentlyEditingTenantId = null;
                if (currentValidationHandler) {
                    DOM.modalInputsContainer.removeEventListener('input', currentValidationHandler);
                    currentValidationHandler = null;
                }
                DOM.modalCancelBtn.style.display = 'inline-block';
                state.isModalOpen = false;
            }

            function showContextMenu(x, y, items) {
                DOM.contextMenu.innerHTML = '';
                items.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'context-menu-item';
                    menuItem.textContent = item.label;
                    menuItem.dataset.action = item.action;
                    menuItem.dataset.id = item.id;
                    DOM.contextMenu.appendChild(menuItem);
                });
                DOM.contextMenu.style.top = `${y}px`;
                DOM.contextMenu.style.left = `${x}px`;
                DOM.contextMenu.style.display = 'block';
            }
            function hideContextMenu() {
                DOM.contextMenu.style.display = 'none';
            }

            // #################################################################
            // ##                         EVENT HANDLERS                      ##
            // #################################################################
            function handleDayClick(day, type) {
                const events = state.tempCalendarData[type]?.[day] || [];
                if (events.length === 0) return;

                let title = "";
                let detailsHtml = `
                    <style>
                        .day-detail-item { display: flex; justify-content: space-between; padding: 0.5rem 0; color: #495057; }
                        .day-detail-item:not(:first-child) { border-top: 1px solid var(--border-color); }
                        .day-detail-item span:last-child { font-weight: 500; }
                        .day-detail-total { display: flex; justify-content: space-between; padding-top: 1rem; margin-top: 0.5rem; border-top: 2px solid #495057; font-weight: 600; font-size: 1.1rem; color: #495057; }
                    </style>
                    <div class="day-details-container">`;

                let totalAmount = 0;

                if (type === 'billing') {
                    title = "Upcoming Bills";
                    events.forEach(item => {
                        const { tenant } = item;
                        const { totalBilling } = getBillingInfo(tenant);
                        totalAmount += totalBilling;
                        detailsHtml += `<div class="day-detail-item"><span>Unit ${tenant.unit} ( ${tenant.name} )</span><span>${totalBilling.toFixed(2)} USD</span></div>`;
                    });
                } else if (type === 'paid') {
                    title = "Payments Received";
                     events.forEach(item => {
                        const { tenant, entry } = item;
                        totalAmount += entry.totalPaid;
                        detailsHtml += `<div class="day-detail-item"><span>Unit ${tenant.unit} ( ${tenant.name} )</span><span>${entry.totalPaid.toFixed(2)} USD</span></div>`;
                    });
                }
                
                detailsHtml += `</div><div class="day-detail-total"><span>Total</span><span>${totalAmount.toFixed(2)} USD</span></div>`;

                showModal({
                    title: title,
                    isConfirmation: true,
                    confirmationText: detailsHtml,
                    saveButtonText: "Close",
                    onSave: hideModal,
                    hideActionsBorder: true,
                });
                DOM.modalCancelBtn.style.display = 'none';
            }

            function handleEditExpensesClick() {
                const date = state.calendarDate;
                const year = date.getFullYear();
                const month = date.getMonth();
                const expenseKey = `${year}-${month}`;

                const initialValues = state.expenses[expenseKey] || { salary: 0, maintenance: 0, tax: 0, other: 0 };

                showModal({
                    title: `Edit Expenses for ${date.toLocaleString('en-US', { month: 'long', year: 'numeric' })}`,
                    fields: [
                        { id: 'salary', label: 'Employee Salary (USD)', type: 'number' },
                        { id: 'maintenance', label: 'Maintenance (USD)', type: 'number' },
                        { id: 'tax', label: 'Tax (USD)', type: 'number' },
                        { id: 'other', label: 'Other (USD)', type: 'number' },
                    ],
                    initialValues: initialValues,
                    onSave: (values) => {
                        if (!state.expenses[expenseKey]) {
                            state.expenses[expenseKey] = {};
                        }
                        state.expenses[expenseKey].salary = parseFloat(values.salary) || 0;
                        state.expenses[expenseKey].maintenance = parseFloat(values.maintenance) || 0;
                        state.expenses[expenseKey].tax = parseFloat(values.tax) || 0;
                        state.expenses[expenseKey].other = parseFloat(values.other) || 0;
                        
                        renderOverview();
                        saveDataToSheet();
                    }
                });
            }

            function handleAddSectionClick() {
                showModal({
                    title: 'Add New Section',
                    fields: [{ id: 'sectionName', label: 'Section Name', placeholder: "e.g., 'Floor 2'" }],
                    requiredFields: ['sectionName'],
                    onSave: (values) => {
                        state.sections.push({ id: state.nextSectionId++, name: values.sectionName, tenants: [] });
                        render();
                        saveDataToSheet();
                    }
                });
            }

            function handleSetRateClick() {
                showModal({
                    title: 'Set Global Rates',
                    fields: [
                        { id: 'electricity', label: 'Electricity Rate (per Kwh)', type: 'number' },
                        { id: 'water', label: 'Water Rate (per m)', type: 'number' },
                        { id: 'parking', label: 'Parking Rate (per vehicle)', type: 'number' },
                    ],
                    initialValues: state.rates,
                    requiredFields: ['electricity', 'water', 'parking'],
                    onSave: (newRates) => {
                        state.rates.electricity = Math.max(0, parseFloat(newRates.electricity)) || 0;
                        state.rates.water = Math.max(0, parseFloat(newRates.water)) || 0;
                        state.rates.parking = Math.max(0, parseFloat(newRates.parking)) || 0;
                        render();
                        saveDataToSheet();
                    }
                });
            }
          function handleAddUnitClick(sectionId) {
    const section = state.sections.find(s => s.id === sectionId);
    if (section) {
        showModal({
            title: `Add Unit to ${section.name}`,
            fields: [{ id: 'unitNumber', label: 'Unit Number', placeholder: "e.g., '101' or 'A-01'" }], // Modified line
            requiredFields: ['unitNumber'],
            onSave: (values) => {
                const newTenant = { ...state.defaultTenantState, id: state.nextTenantId++, unit: values.unitNumber, paymentHistory: [], sectionId: section.id };
                section.tenants.push(newTenant);
                render();
                saveDataToSheet();
                        }
                    });
                }
            }
            function handleSummaryClick(tenantId) {
                state.currentlyExpandedTenantId = (state.currentlyExpandedTenantId === tenantId) ? null : tenantId;
                render();
            }
            function handleEditClick(tenantId, onCancelOverride) {
                state.currentlyEditingTenantId = tenantId;
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;

                const formValues = { ...tenant };
                const dateFields = ['leaseStart', 'idExpiry', 'passportExpiry', 'visaExpiry', 'currentBillingDate'];
                dateFields.forEach(field => {
                    if (formValues[field]) {
                        formValues[field] = formValues[field].split('T')[0];
                    }
                });
                if (formValues.name && (!formValues.pax || formValues.pax === '0')) {
                    formValues.pax = '1';
                }

                showModal({
                    isEdit: true,
                    title: `Edit: ${tenant.name || `Unit ${tenant.unit}`}`,
                    fields: [
                        { id: 'nationality', type: 'nationality' },
                        { id: 'name', label: 'Tenant Name' },
                        { id: 'leaseStart', label: 'Lease Start', type: 'date' },
                        { id: 'tenure', label: 'Tenure (in months)', type: 'number' },
                        { id: 'rent', label: 'Rent (USD)', type: 'number' },
                        { type: 'spacer' },
                        { id: 'fpcsFields', type: 'fpcsFields' },
                        { id: 'phone', label: 'Phone' },
                        { id: 'pax', label: 'Pax', type: 'number' },
                        { id: 'vehicles', label: 'Vehicles', type: 'vehicles' },
                        { id: 'documentFields', type: 'documentFields' },
                        { type: 'spacer' },
                        { id: 'unit', label: 'Unit Number' },
                        { id: 'currentBillingDate', label: 'Billing Date', type: 'date' },
                        { id: 'elecPrev', label: 'Electricity Previous (Kwh)', type: 'number' },
                        { id: 'waterPrev', label: 'Water Previous (m)', type: 'number' },
                    ],
                    initialValues: formValues,
                    requiredFields: ['name', 'leaseStart', 'tenure', 'rent', 'pax'],
                    validationRules: [
                        { fieldId: 'rent', validator: (val) => parseFloat(val) >= 0, message: 'Rent cannot be negative.' },
                        { fieldId: 'pax', validator: (val) => parseFloat(val) > 0, message: 'Pax must be at least 1.' }
                    ],
                    onSave: (newValues) => {
                        if (newValues.leaseStart && newValues.tenure) {
                           newValues.leaseEnd = calculateLeaseEndDate(newValues.leaseStart, newValues.tenure);
                        }
                        if (newValues.leaseStart !== tenant.leaseStart) {
                            newValues.currentBillingDate = calculateFirstBillingDate(newValues.leaseStart);
                        }
                        if (newValues.nationality === 'Local') {
                            Object.assign(newValues, { passportExpiry: '', visaExpiry: '', fpcs: 'No' });
                        } else {
                            newValues.idExpiry = '';
                        }
                        Object.assign(tenant, newValues);
                        render();
                        saveDataToSheet();
                    },
                    onCancel: onCancelOverride
                });
            }

            function handlePaidClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                const { totalBilling } = getBillingInfo(tenant);

                showModal({
                    title: "Confirm Payment",
                    isConfirmation: true,
                    confirmationText: `Mark payment for ${tenant.name} (Unit ${tenant.unit}) as paid? This will advance the billing date and reset usage meters.`,
                    onSave: () => {
                          const { elecBilling, waterBilling, parkingBilling } = getBillingInfo(tenant);
                          const elecUsage = (tenant.elecCurrent || 0) - (tenant.elecPrev || 0);
                          const waterUsage = (tenant.waterCurrent || 0) - (tenant.waterPrev || 0);
                        const historyEntry = {
                            billingDate: tenant.currentBillingDate, // Record the original billing date
                            paidOn: new Date().toISOString().split('T')[0], // Record the actual paid date
                            elecUsage: `${elecUsage} Kwh`, waterUsage: `${waterUsage} m`,
                            rent: parseFloat(tenant.rent || 0), other: parseFloat(tenant.other || 0), parking: parkingBilling,
                            totalPaid: totalBilling
                        };
                                                if (!tenant.paymentHistory) tenant.paymentHistory = [];
                        tenant.paymentHistory.push(historyEntry);
                                                Object.assign(tenant, {
                            currentBillingDate: calculateNextBillingDate(tenant.currentBillingDate, tenant.leaseStart),
                            elecPrev: tenant.elecCurrent,
                            waterPrev: tenant.waterCurrent,
                            elecCurrent: "",
                            waterCurrent: "",
                            other: ""
                        });

                        render();
                        saveDataToSheet();
                    }
                });
            }
            function handleBillClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                showModal({
                    title: `Enter New Readings for ${tenant.name}`,
                    fields: [
                        { id: 'elecCurrent', label: `Electricity New (Kwh) - Prev: ${tenant.elecPrev || 0}`, type: 'number' },
                        { id: 'waterCurrent', label: `Water New (m) - Prev: ${tenant.waterPrev || 0}`, type: 'number' },
                        { id: 'other', label: 'Other Fees (USD)', type: 'number' },
                    ],
                    initialValues: tenant,
                    requiredFields: ['elecCurrent', 'waterCurrent'],
                    validationRules: [
                        { fieldId: 'elecCurrent', validator: val => parseFloat(val) >= parseFloat(tenant.elecPrev || 0), message: `New reading cannot be less than previous (${tenant.elecPrev || 0}).` },
                        { fieldId: 'waterCurrent', validator: val => parseFloat(val) >= parseFloat(tenant.waterPrev || 0), message: `New reading cannot be less than previous (${tenant.waterPrev || 0}).` }
                    ],
                    onSave: (newReadings) => {
                        tenant.elecCurrent = parseFloat(newReadings.elecCurrent) || tenant.elecPrev;
                        tenant.waterCurrent = parseFloat(newReadings.waterCurrent) || tenant.waterPrev;
                        tenant.other = Math.max(0, parseFloat(newReadings.other)) || 0;
                        render();
                        saveDataToSheet();
                    }
                });
            }
            function handleHistoryClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant?.paymentHistory?.length) return;

                const historyRows = [...tenant.paymentHistory].reverse().map(entry => `
                    <tr>
                        <td>${formatDate(entry.paidOn)}</td>
                        <td>${entry.elecUsage}</td>
                        <td>${entry.waterUsage}</td>
                        <td>${(entry.rent || 0).toFixed(2)}</td>
                        <td>${(entry.other || 0).toFixed(2)}</td>
                        <td>${(entry.parking || 0).toFixed(2)}</td>
                        <td><strong>${(entry.totalPaid || 0).toFixed(2)}</strong></td>
                    </tr>`
                ).join('');

                const historyHtml = `
                    <style>
                        .history-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; table-layout: fixed; }
                        .history-table th, .history-table td { padding: 8px 6px; border: 1px solid var(--border-color); text-align: right; word-wrap: break-word; }
                        .history-table th:first-child, .history-table td:first-child { text-align: left; width: 80px;}
                        .history-table th { background-color: #f8f9fa; font-weight: 500; }
                    </style>
                    <table class="history-table">
                        <thead><tr><th>Paid Date</th><th>Elec.</th><th>Water</th><th>Rent</th><th>Other</th><th>Parking</th><th>Total</th></tr></thead>
                        <tbody>${historyRows}</tbody>
                    </table>`;
                                showModal({
                    title: `Payment History: ${tenant.name}`,
                    isConfirmation: true,
                    confirmationText: historyHtml,
                    saveButtonText: "Close",
                    onSave: hideModal,
                    isHistory: true,
                });
                DOM.modalCancelBtn.style.display = 'none';
            }
            function handleDeleteClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                showModal({
                    title: `Delete Tenant in Unit ${tenant.unit}?`, isConfirmation: true, isDelete: true,
                    confirmationText: "This will clear all tenant data from the unit but keep the unit itself. This action cannot be undone. To proceed, type 'confirm' below.",
                    onSave: () => {
                        Object.keys(state.defaultTenantState).forEach(key => {
                            tenant[key] = state.defaultTenantState[key];
                        });
                        render();
                        saveDataToSheet();
                    }
                });
            }
            function handleDeleteUnitEntirely(tenantId) {
                const { tenant, section } = findTenant(tenantId);
                if (!tenant || !section) return;
                showModal({
                    title: `Delete Unit ${tenant.unit} Permanently?`, isConfirmation: true, isDelete: true,
                    confirmationText: `This will permanently delete Unit ${tenant.unit} and all its data. This action cannot be undone. To proceed, type 'confirm' below.`,
                    onSave: () => {
                        section.tenants = section.tenants.filter(t => t.id !== tenantId);
                        render();
                        saveDataToSheet();
                    }
                });
            }
            function handleDeleteSection(sectionId) {
                const section = state.sections.find(s => s.id === sectionId);
                if (!section) return;
                showModal({
                    title: `Delete Section "${section.name}"?`, isConfirmation: true, isDelete: true,
                    confirmationText: `This will permanently delete the section "${section.name}" and all units within it. This action cannot be undone. To proceed, type 'confirm' below.`,
                    onSave: () => {
                        state.sections = state.sections.filter(s => s.id !== sectionId);
                        render();
                        saveDataToSheet();
                    }
                });
            }
            function handleModalSave() {
                if (!state.currentModalCallback) { hideModal(); return; }
                const values = {};
                DOM.modalInputsContainer.querySelectorAll('input:not(.vehicle-input)').forEach(input => {
                    if (input.type === 'radio') {
                        if (input.checked) values[input.name] = input.value;
                    } else {
                        values[input.id] = input.value;
                    }
                });
                const vehicleContainer = DOM.modalInputsContainer.querySelector('#vehicle-input-container');
                if (vehicleContainer) {
                    const vehicleInputs = vehicleContainer.querySelectorAll('.vehicle-input');
                    values.vehicles = Array.from(vehicleInputs).map(input => input.value.trim()).filter(Boolean);
                }
                if (state.currentModalCallback(values) !== false) {
                    hideModal();
                }
            }

            function handleModalCancel() {
                if (state.currentModalCancelCallback) {
                    if (state.currentModalCancelCallback() !== false) hideModal();
                } else {
                    hideModal();
                }
            }
            function handleModalRenew() {
                const tenantId = state.currentlyEditingTenantId;
                if (!tenantId) return;
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                const originalLeaseData = { leaseStart: tenant.leaseStart, leaseEnd: tenant.leaseEnd, tenure: tenant.tenure, currentBillingDate: tenant.currentBillingDate };
                                showModal({
                    title: "Confirm Renewal", isConfirmation: true,
                    confirmationText: "Are you sure you want to renew this lease? This will clear the current lease start, tenure, and billing date fields, allowing you to enter new ones.",
                    onSave: () => {
                        Object.assign(tenant, { leaseStart: '', tenure: '', currentBillingDate: '', leaseEnd: '' });
                        handleEditClick(tenantId, () => {
                            const { tenant: tenantToRestore } = findTenant(tenantId);
                            if (tenantToRestore) {
                                Object.assign(tenantToRestore, originalLeaseData);
                                render();
                            }
                        });
                        return false;
                    },
                    onCancel: () => { handleEditClick(tenantId); return false; },
                });
            }
            // #################################################################
            // ##                    INITIALIZATION & BINDING                 ##
            // #################################################################
            function init() {
                loadDataFromSheet().then(() => {
                    render(); // Initial render after data is loaded
                });
                
                DOM.sectionsContainer.addEventListener('click', (event) => {
                    const target = event.target;
                    const tenantItem = target.closest('.tenant-item');
                    const tenantId = tenantItem ? parseInt(tenantItem.dataset.tenantId, 10) : null;

                    const actions = {
                        'add-tenant-btn': () => handleAddUnitClick(parseInt(target.closest('.add-tenant-btn').dataset.sectionId, 10)),
                        'tenant-summary': () => handleSummaryClick(tenantId),
                        'edt-btn': () => handleEditClick(tenantId),
                        'paid-btn': () => handlePaidClick(tenantId),
                        'bill-btn': () => handleBillClick(tenantId),
                        'dlt-btn': () => handleDeleteClick(tenantId),
                        'history-btn': () => handleHistoryClick(tenantId),
                    };

                    for (const cls in actions) {
                        if (target.closest(`.${cls}`)) {
                            actions[cls]();
                            return;
                        }
                    }
                });

                DOM.calendarGrid.addEventListener('click', (event) => {
                    const dayCell = event.target.closest('.calendar-day[data-day]');
                    if (dayCell) {
                        const day = parseInt(dayCell.dataset.day, 10);
                        const type = dayCell.dataset.type;
                        if (type) {
                           handleDayClick(day, type);
                        }
                    }
                });

                document.body.addEventListener('contextmenu', (event) => {
                    hideContextMenu();
                    const sectionHeader = event.target.closest('.floor-header h2');
                    const tenantSummary = event.target.closest('.tenant-summary');
                    const expenseHeader = event.target.closest('#expense-header');

                    if (expenseHeader) {
                         event.preventDefault();
                         showContextMenu(event.pageX, event.pageY, [{ label: 'Edit Expenses', action: 'edit-expenses' }]);
                    } else if (sectionHeader) {
                        event.preventDefault();
                        const sectionId = parseInt(event.target.closest('.floor-container').dataset.sectionId, 10);
                        showContextMenu(event.pageX, event.pageY, [{ label: 'Delete Section', action: 'delete-section', id: sectionId }]);
                    } else if (tenantSummary) {
                        event.preventDefault();
                        const tenantId = parseInt(event.target.closest('.tenant-item').dataset.tenantId, 10);
                        showContextMenu(event.pageX, event.pageY, [{ label: 'Delete Unit', action: 'delete-unit', id: tenantId }]);
                    }
                });

                DOM.contextMenu.addEventListener('click', (event) => {
                    const target = event.target.closest('.context-menu-item');
                    if (!target) return;
                    const { action, id } = target.dataset;
                    
                    if (action === 'edit-expenses') handleEditExpensesClick();
                    else if (action === 'delete-section') handleDeleteSection(parseInt(id, 10));
                    else if (action === 'delete-unit') handleDeleteUnitEntirely(parseInt(id, 10));
                    
                    hideContextMenu();
                });

                DOM.modalInputsContainer.addEventListener('click', event => {
                    if (event.target.id === 'add-vehicle-btn') {
                        document.getElementById('vehicle-input-container').appendChild(createVehicleInput());
                    }
                    if (event.target.classList.contains('remove-vehicle-btn')) {
                        event.target.closest('.vehicle-input-group').remove();
                    }
                });
                                DOM.prevMonthBtn.addEventListener('click', () => {
                    state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                    renderCalendar();
                    renderOverview();
                });

                DOM.nextMonthBtn.addEventListener('click', () => {
                    state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                    renderCalendar();
                    renderOverview();
                });

                // Global listeners
                window.addEventListener('click', (e) => {
                    if (!DOM.contextMenu.contains(e.target)) {
                        hideContextMenu();
                    }
                });
                DOM.addSectionBtn.addEventListener('click', handleAddSectionClick);
                DOM.setRateBtn.addEventListener('click', handleSetRateClick);
                DOM.modalSaveBtn.addEventListener('click', handleModalSave);
                DOM.modalCancelBtn.addEventListener('click', handleModalCancel);
                DOM.modalRenewBtn.addEventListener('click', handleModalRenew);
            }
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
